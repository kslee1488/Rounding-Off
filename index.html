<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Round Off Explorer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom animation for highlighting */
        @keyframes highlight {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .animate-highlight {
            animation: highlight 0.3s ease-in-out;
        }
        .dashed-ring {
            border-style: dashed;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons (Inline SVGs to replace Lucide React) ---
        const ArrowRight = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        );
        const Info = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        );
        const RefreshCw = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
        );
        const Hash = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></svg>
        );
        const ChevronRight = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>
        );
        const Check = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 6 9 17l-5-5"/></svg>
        );
        const Trophy = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
        );
        const Play = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="6 3 20 12 6 21 6 3"/></svg>
        );
        const XCircle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
        );
        const CheckCircle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>
        );
        const User = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        );

        // --- Components ---

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden ${className}`}>
                {children}
            </div>
        );

        const Button = ({ onClick, children, active = false, className = "", disabled = false }) => (
            <button
                onClick={onClick}
                disabled={disabled}
                className={`px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 ${
                active
                    ? 'bg-blue-600 text-white shadow-md transform scale-105'
                    : disabled 
                    ? 'bg-slate-100 text-slate-400 cursor-not-allowed'
                    : 'bg-blue-100 text-blue-700 hover:bg-blue-200' 
                } ${className}`}
            >
                {children}
            </button>
        );

        const Badge = ({ children, color = "blue" }) => {
            const colors = {
                blue: "bg-blue-100 text-blue-800 border-blue-200",
                red: "bg-red-100 text-red-800 border-red-200",
                green: "bg-green-100 text-green-800 border-green-200",
                amber: "bg-amber-100 text-amber-800 border-amber-200",
            };
            return (
                <span className={`px-2 py-0.5 rounded-md text-xs font-bold border ${colors[color] || colors.blue}`}>
                {children}
                </span>
            );
        };

        // --- Main App Component ---

        function App() {
            // Explorer State
            const [mode, setMode] = useState('whole'); // 'whole', 'decimal', 'sigfig'
            const [number, setNumber] = useState(1234.5678);
            const [precision, setPrecision] = useState(10); // Default to Nearest 10
            const [animate, setAnimate] = useState(false);
            
            // Quiz State
            const [quizMode, setQuizMode] = useState(false);
            const [quizStep, setQuizStep] = useState('setup'); // 'setup' | 'playing'
            const [username, setUsername] = useState('');
            const [quizSubmitted, setQuizSubmitted] = useState(false);
            const [userGuess, setUserGuess] = useState('');
            const [score, setScore] = useState(0);
            const [totalQuestions, setTotalQuestions] = useState(0);
            const [feedback, setFeedback] = useState(null); // 'correct' | 'incorrect'
            
            // Auto-advance timer ref
            const autoAdvanceTimer = useRef(null);
            // Input ref for auto-focus
            const inputRef = useRef(null);

            // Constants for limits
            const MODES = {
                whole: { 
                label: 'Whole Numbers', 
                options: [
                    { val: 10, label: 'Nearest 10' },
                    { val: 100, label: 'Nearest 100' },
                    { val: 1000, label: 'Nearest 1,000' }
                ]
                },
                decimal: { 
                label: 'Decimal Places', 
                options: [
                    { val: 0, label: '0 d.p. (Whole)' },
                    { val: 1, label: '1 d.p.' },
                    { val: 2, label: '2 d.p.' },
                    { val: 3, label: '3 d.p.' }
                ]
                },
                sigfig: { 
                label: 'Significant Figures', 
                options: [
                    { val: 1, label: '1 s.f.' },
                    { val: 2, label: '2 s.f.' },
                    { val: 3, label: '3 s.f.' },
                    { val: 4, label: '4 s.f.' }
                ]
                }
            };

            // Helper to calculate rounding logic
            const calculateRounding = () => {
                let rounded, lower, upper, step, description;
                let roundedStr = ''; // Formatted string for display (preserves zeros)
                
                // Parse pure number for calculation
                const val = parseFloat(number);

                // Helper to clean floats for math/bounds (avoids 0.30000000004)
                const cleanFloat = (n) => parseFloat(n.toPrecision(12));

                if (mode === 'whole') {
                step = precision;
                lower = Math.floor(val / step) * step;
                upper = lower + step;
                
                // Handle negative numbers symmetry
                if (val < 0) {
                    lower = Math.ceil(val / step) * step;
                    upper = lower - step; 
                    const temp = lower; lower = upper; upper = temp;
                }
                
                rounded = Math.round(val / step) * step;
                roundedStr = rounded.toString();
                description = `Rounding to nearest ${step}`;
                } 
                else if (mode === 'decimal') {
                const factor = Math.pow(10, precision);
                lower = Math.floor(val * factor) / factor;
                upper = lower + (1/factor);
                rounded = Math.round(val * factor) / factor;
                
                lower = cleanFloat(lower);
                upper = cleanFloat(upper);
                
                // Use toFixed to guarantee decimal places (e.g., 1.50)
                roundedStr = rounded.toFixed(precision);
                
                description = `Rounding to ${precision} decimal place${precision !== 1 ? 's' : ''}`;
                } 
                else if (mode === 'sigfig') {
                if (val === 0) {
                    rounded = 0;
                    lower = 0;
                    upper = 0;
                    roundedStr = new Intl.NumberFormat('en-US', { 
                        minimumSignificantDigits: precision, 
                        maximumSignificantDigits: precision, 
                        useGrouping: false 
                    }).format(0);
                } else {
                    const magnitude = Math.floor(Math.log10(Math.abs(val)));
                    const scale = Math.pow(10, magnitude - precision + 1);
                    
                    step = scale;
                    lower = Math.floor(val / step) * step;
                    upper = lower + step;
                    rounded = Math.round(val / step) * step;
                    
                    // Use Intl.NumberFormat to avoid scientific notation (7.2e+2) while keeping sig figs (720 or 80.0)
                    roundedStr = new Intl.NumberFormat('en-US', { 
                        minimumSignificantDigits: precision, 
                        maximumSignificantDigits: precision, 
                        useGrouping: false 
                    }).format(cleanFloat(rounded));
                }
                description = `Rounding to ${precision} significant figure${precision !== 1 ? 's' : ''}`;
                }
                
                return { 
                rounded: cleanFloat(rounded), 
                roundedStr: roundedStr,       
                lower: cleanFloat(lower), 
                upper: cleanFloat(upper), 
                description 
                };
            };

            const results = calculateRounding();

            // Generate a random number appropriate for the current mode
            const generateRandom = () => {
                let newNum;
                if (mode === 'whole') {
                newNum = Math.floor(Math.random() * 9000) + 100; 
                } else if (mode === 'decimal') {
                newNum = (Math.random() * 100).toFixed(4);
                } else {
                if (Math.random() > 0.5) {
                    newNum = (Math.random() * 1000).toFixed(2);
                } else {
                    newNum = (Math.random() * 0.1).toFixed(5);
                }
                }
                setNumber(parseFloat(newNum));
                setAnimate(true);
                setTimeout(() => setAnimate(false), 500);
            };

            const startQuiz = () => {
                setQuizMode(true);
                setQuizStep('setup');
                setScore(0);
                setTotalQuestions(0);
                setUsername(''); 
            };

            const startGame = () => {
                if (!username.trim()) return;
                setQuizStep('playing');
                nextQuestion();
            };

            const exitQuiz = () => {
                if (autoAdvanceTimer.current) {
                clearTimeout(autoAdvanceTimer.current);
                }
                setQuizMode(false);
                setQuizSubmitted(false);
                setQuizStep('setup');
            };

            const nextQuestion = () => {
                // Clear timer if user clicks manually to avoid double skip
                if (autoAdvanceTimer.current) {
                    clearTimeout(autoAdvanceTimer.current);
                    autoAdvanceTimer.current = null;
                }

                // Weighted Random Mode Selection: 20% Whole, 40% Decimal, 40% SigFig
                const rand = Math.random();
                let randomMode;
                if (rand < 0.2) {
                    randomMode = 'whole';
                } else if (rand < 0.6) {
                    randomMode = 'decimal';
                } else {
                    randomMode = 'sigfig';
                }

                const options = MODES[randomMode].options;
                const randomOption = options[Math.floor(Math.random() * options.length)];
                
                let newNum;
                if (randomMode === 'whole') {
                newNum = Math.floor(Math.random() * 9000) + 100; 
                } else if (randomMode === 'decimal') {
                newNum = (Math.random() * 100).toFixed(4);
                } else {
                // Sig Fig Probabilities: 25% each for >=1, 1 leading zero, 2 leading zeros, 3 leading zeros
                const sfType = Math.random();
                if (sfType < 0.25) {
                    // Whole/Mixed numbers >= 1 (e.g. 12.345)
                    newNum = (Math.random() * 1000 + 1).toPrecision(6);
                } else if (sfType < 0.5) {
                    // 1 Leading Zero (0.1 to 0.999...)
                    newNum = (Math.random() * 0.9 + 0.1).toPrecision(6);
                } else if (sfType < 0.75) {
                    // 2 Leading Zeros (0.01 to 0.099...)
                    newNum = (Math.random() * 0.09 + 0.01).toPrecision(6);
                } else {
                    // 3 Leading Zeros (0.001 to 0.0099...)
                    newNum = (Math.random() * 0.009 + 0.001).toPrecision(6);
                }
                }

                setMode(randomMode);
                setPrecision(randomOption.val);
                setNumber(parseFloat(newNum));
                setQuizSubmitted(false);
                setUserGuess('');
                setFeedback(null);
            };

            const submitAnswer = () => {
                if (!userGuess) return;
                
                const correct = results.rounded;
                const userVal = parseFloat(userGuess);
                const isCorrect = Math.abs(userVal - correct) < Number.EPSILON; 
                
                setFeedback(isCorrect ? 'correct' : 'incorrect');
                if (isCorrect) {
                    setScore(s => s + 1);
                    // Auto-advance after 3 seconds if correct
                    autoAdvanceTimer.current = setTimeout(() => {
                        nextQuestion();
                    }, 3000);
                }
                setTotalQuestions(t => t + 1);
                setQuizSubmitted(true);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    if (quizStep === 'setup') {
                        startGame();
                    } else if (!quizSubmitted) {
                        submitAnswer();
                    } else {
                        nextQuestion();
                    }
                }
            };

            // Effect to handle auto-focus on input when question changes or quiz starts
            useEffect(() => {
                if (quizMode && quizStep === 'playing' && !quizSubmitted) {
                // Small timeout to ensure DOM is ready and focus isn't stolen by button clicks
                const timer = setTimeout(() => {
                    inputRef.current?.focus();
                }, 50);
                return () => clearTimeout(timer);
                }
            }, [quizMode, quizStep, quizSubmitted, totalQuestions]); // Dependencies trigger on new question state

            // --- Visualization Helpers ---

            const analyzeDigits = () => {
                let str = number.toString();
                
                // PADDING LOGIC for Visualization
                // Ensure we have enough digits to show Target and Decider
                if (!str.includes('.')) str += '.';
                
                if (mode === 'decimal') {
                    // We need (precision + 1) digits after the decimal point to show target+decider
                    const parts = str.split('.');
                    let decimals = parts[1];
                    const needed = precision + 1;
                    while (decimals.length < needed) {
                        decimals += '0';
                    }
                    str = parts[0] + '.' + decimals;
                } else if (mode === 'sigfig') {
                    // We need (precision + 1) significant figures
                    const testStr = str.replace('.', ''); // string without dot
                    // Find first non-zero digit index in original string logic
                    let sigCount = 0;
                    let started = false;
                    
                    // Count current sig figs in the rough string
                    for (let c of testStr) {
                        if (c !== '0') started = true;
                        if (started) sigCount++;
                    }
                    // If number is 0
                    if (!started) sigCount = 0;

                    const needed = precision + 1; // Need target + 1 for decider
                    let toAdd = needed - sigCount;
                    if (toAdd < 0) toAdd = 0;
                    
                    // Append zeros
                    str += '0'.repeat(toAdd);
                }

                let chars = str.split('').map((char, index) => ({
                char,
                index,
                isTarget: false,
                isDecider: false,
                }));

                // Find decimal point in the NEW string
                let decimalPointIndex = chars.findIndex(c => c.char === '.');
                
                let targetIdx = -1;
                let deciderIdx = -1;

                if (mode === 'whole') {
                // Logic for whole numbers
                targetIdx = decimalPointIndex - Math.log10(precision) - 1;
                } 
                else if (mode === 'decimal') {
                targetIdx = decimalPointIndex + precision;
                }
                else if (mode === 'sigfig') {
                let sigCount = 0;
                let i = 0;
                while (i < chars.length) {
                    const c = chars[i].char;
                    if (c !== '.' && (sigCount > 0 || c !== '0')) {
                    sigCount++;
                    }
                    if (sigCount === precision) {
                    targetIdx = i;
                    break;
                    }
                    i++;
                }
                }

                if (targetIdx !== -1) {
                    deciderIdx = targetIdx + 1;
                    if (chars[deciderIdx] && chars[deciderIdx].char === '.') {
                        deciderIdx++;
                    }
                }

                // Since we padded the string, these indices should now be valid
                if (targetIdx >= 0 && targetIdx < chars.length) chars[targetIdx].isTarget = true;
                if (deciderIdx >= 0 && deciderIdx < chars.length) chars[deciderIdx].isDecider = true;

                return { chars, targetIdx, deciderIdx };
            };

            const { chars, targetIdx, deciderIdx } = analyzeDigits();

            const isRoundingUp = Math.abs(results.rounded) > Math.abs(number) && Math.abs(results.rounded) !== Math.abs(number);
            const deciderDigit = deciderIdx >= 0 && deciderIdx < chars.length ? parseInt(chars[deciderIdx].char) : 0;
            const shouldRoundUp = deciderDigit >= 5;

            const showVisualization = !quizMode || (quizStep === 'playing' && quizSubmitted);

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800">
                <div className="max-w-5xl mx-auto space-y-6">
                    
                    {/* Header */}
                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-2">
                        <RefreshCw className="w-8 h-8 text-blue-600" />
                        Rounding Off Explorer
                        </h1>
                        <p className="text-slate-500 mt-1">
                        {quizMode ? 'Quiz Mode: Test your estimation skills' : 'Interactive Visualization Mode'}
                        </p>
                    </div>
                    
                    <div className="flex gap-4 items-center flex-wrap">
                        {quizMode && quizStep === 'playing' && (
                        <div className="flex items-center gap-3 animate-in fade-in duration-300">
                            <div className="flex items-center gap-2 px-3 py-2 bg-indigo-50 text-indigo-700 rounded-lg border border-indigo-100">
                                <User className="w-4 h-4" />
                                <span className="font-bold text-sm max-w-[100px] truncate">{username}</span>
                            </div>
                            <div className="flex items-center gap-2 bg-yellow-50 px-4 py-2 rounded-lg border border-yellow-200">
                                <Trophy className="w-5 h-5 text-yellow-600" />
                                <span className="font-bold text-yellow-800">Score: {score} / {totalQuestions}</span>
                            </div>
                        </div>
                        )}

                        {!quizMode ? (
                        <button
                            onClick={startQuiz}
                            className="px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center gap-2 bg-blue-600 text-white hover:bg-blue-700 shadow-md hover:shadow-lg hover:-translate-y-0.5"
                        >
                            <Play className="w-4 h-4" /> Start Quiz
                        </button>
                        ) : (
                        <Button onClick={exitQuiz} className="text-red-600 hover:text-red-700 hover:bg-red-50">
                            <XCircle className="w-4 h-4" /> Exit Quiz
                        </Button>
                        )}
                    </div>
                    </div>

                    {/* MODE TABS (Only visible in Explorer Mode) */}
                    {!quizMode && (
                    <div className="flex justify-center md:justify-end">
                        <div className="flex gap-2 bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                        {Object.keys(MODES).map(m => (
                            <button
                            key={m}
                            onClick={() => { setMode(m); setPrecision(MODES[m].options[0].val); }}
                            className={`px-4 py-2 rounded-md text-sm font-medium transition-all ${
                                mode === m 
                                ? 'bg-blue-600 text-white shadow-sm' 
                                : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                            }`}
                            >
                            {MODES[m].label}
                            </button>
                        ))}
                        </div>
                    </div>
                    )}

                    {/* Main Interaction Area */}
                    <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                    
                    {/* Left Panel: Inputs OR Quiz Question */}
                    <div className="md:col-span-4 space-y-4">
                        
                        {quizMode ? (
                        quizStep === 'setup' ? (
                            /* QUIZ NAME INPUT */
                            <Card className="p-8 h-full flex flex-col items-center justify-center text-center space-y-6 relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-1 bg-blue-500"></div>
                                <div className="bg-blue-100 p-4 rounded-full">
                                    <User className="w-8 h-8 text-blue-600" />
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold text-slate-800">Welcome!</h3>
                                    <p className="text-slate-500 text-sm mt-1">Enter your name to start the challenge.</p>
                                </div>
                                <div className="w-full space-y-3">
                                    <input 
                                        type="text" 
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && startGame()}
                                        placeholder="Your Name"
                                        className="w-full text-center text-lg p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder:text-slate-300"
                                        autoFocus
                                    />
                                    <Button 
                                        onClick={startGame} 
                                        disabled={!username.trim()}
                                        className={`w-full justify-center py-3 text-white ${username.trim() ? 'bg-blue-600 hover:bg-blue-700' : 'bg-slate-200'}`}
                                    >
                                        Start Game <ArrowRight className="w-4 h-4" />
                                    </Button>
                                </div>
                            </Card>
                        ) : (
                            /* QUIZ PANEL (Playing) */
                            <Card className="p-6 h-full flex flex-col relative overflow-hidden animate-in slide-in-from-right-4 duration-300">
                                <div className="absolute top-0 left-0 w-full h-1 bg-blue-500"></div>
                                
                                <div className="mb-6">
                                <span className="text-xs font-bold text-blue-500 uppercase tracking-wider">Question {totalQuestions + 1}</span>
                                <h3 className="text-xl font-bold text-slate-800 mt-1">
                                    {MODES[mode].label}
                                </h3>
                                <p className="text-slate-500 text-sm">
                                    Round off <span className="font-mono bg-slate-100 px-1 rounded">{number}</span> to the {MODES[mode].options.find(o => o.val === precision)?.label.toLowerCase()}
                                </p>
                                </div>

                                <div className="space-y-4 flex-grow">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Your Answer</label>
                                    <input
                                    ref={inputRef}
                                    type="text"
                                    value={userGuess}
                                    onChange={(e) => setUserGuess(e.target.value)}
                                    onKeyDown={handleKeyDown}
                                    disabled={quizSubmitted}
                                    placeholder="Enter rounded value..."
                                    className={`w-full text-lg p-3 border rounded-lg outline-none transition-all ${
                                        quizSubmitted 
                                            ? feedback === 'correct' 
                                                ? 'border-green-500 bg-green-50 text-green-900' 
                                                : 'border-red-500 bg-red-50 text-red-900'
                                            : 'border-slate-300 focus:ring-2 focus:ring-blue-500'
                                    }`}
                                    autoFocus
                                    />
                                </div>
                                
                                {!quizSubmitted ? (
                                    <Button onClick={submitAnswer} active className="w-full justify-center py-3 bg-blue-600 hover:bg-blue-700 text-white">
                                    Submit Answer
                                    </Button>
                                ) : (
                                    <div className="animate-in fade-in slide-in-from-bottom-4 duration-300">
                                    <div className={`p-3 rounded-lg flex items-center gap-3 mb-4 ${
                                        feedback === 'correct' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                    }`}>
                                        {feedback === 'correct' ? <CheckCircle className="w-6 h-6" /> : <XCircle className="w-6 h-6" />}
                                        <div className="flex-1">
                                        <p className="font-bold">{feedback === 'correct' ? 'Correct!' : 'Incorrect'}</p>
                                        {feedback === 'incorrect' && (
                                            <p className="text-sm">The correct answer is <strong>{results.roundedStr}</strong></p>
                                        )}
                                        </div>
                                    </div>
                                    <Button onClick={nextQuestion} className="w-full justify-center py-3 bg-blue-600 text-white hover:bg-blue-700">
                                        Next Question <ArrowRight className="w-4 h-4" />
                                    </Button>
                                    </div>
                                )}
                                </div>
                            </Card>
                        )
                        ) : (
                        /* EXPLORER CONTROLS */
                        <>
                            <Card className="p-6">
                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">
                                Number Input
                            </label>
                            <div className="flex gap-2 mb-6">
                                <input
                                type="number"
                                value={number}
                                onChange={(e) => setNumber(parseFloat(e.target.value) || 0)}
                                className="w-full text-lg p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
                                />
                                <button 
                                onClick={generateRandom}
                                className="p-3 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors shadow-sm"
                                title="Random Number"
                                >
                                <Hash className="w-6 h-6" />
                                </button>
                            </div>

                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">
                                Precision Level
                            </label>
                            <div className="space-y-2">
                                {MODES[mode].options.map((opt) => (
                                <button
                                    key={opt.label}
                                    onClick={() => setPrecision(opt.val)}
                                    className={`w-full text-left px-4 py-3 rounded-lg border transition-all flex items-center justify-between ${
                                    precision === opt.val
                                        ? 'bg-blue-600 text-white border-blue-600 shadow-md'
                                        : 'bg-blue-50 border-blue-100 text-blue-700 hover:bg-blue-100'
                                    }`}
                                >
                                    <span className={`text-sm ${precision === opt.val ? 'font-bold text-white' : 'text-blue-900'}`}>
                                    {opt.label}
                                    </span>
                                    {precision === opt.val && <Check className="w-4 h-4 text-white" />}
                                </button>
                                ))}
                            </div>
                            </Card>

                            <Card className="p-6 bg-gradient-to-br from-indigo-50 to-blue-50 border-indigo-100">
                            <h3 className="font-bold text-indigo-900 mb-2 flex items-center gap-2">
                                <Info className="w-4 h-4" />
                                The Rule
                            </h3>
                            <p className="text-sm text-indigo-800 leading-relaxed">
                                Look at the <span className="font-bold text-red-600">decider digit</span> (the one to the right of your target).
                            </p>
                            <div className="mt-3 space-y-2">
                                <div className="flex items-center gap-3 text-sm">
                                <Badge color="green">0 - 4</Badge> 
                                <span className="text-indigo-700">Round Down (Stay)</span>
                                </div>
                                <div className="flex items-center gap-3 text-sm">
                                <Badge color="red">5 - 9</Badge> 
                                <span className="text-indigo-700">Round Up (+1)</span>
                                </div>
                            </div>
                            </Card>
                        </>
                        )}
                    </div>

                    {/* Right Panel: Visualization */}
                    <div className="md:col-span-8 space-y-6">
                        
                        {/* Digit Inspector */}
                        <Card className="p-8 flex flex-col items-center justify-center min-h-[200px] relative transition-all duration-500">
                        <div className="absolute top-4 left-4 text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                            Digit Inspector
                            {quizMode && !showVisualization && quizStep === 'playing' && <span className="bg-blue-100 text-blue-600 px-2 rounded text-[10px]">Hidden</span>}
                        </div>
                        
                        <div className="flex flex-wrap items-center justify-center text-5xl md:text-6xl font-mono tracking-widest gap-1 select-none">
                            {quizStep === 'setup' && quizMode ? (
                                <div className="text-slate-300 text-lg font-sans tracking-normal flex flex-col items-center gap-2">
                                    <User className="w-12 h-12 text-slate-200" />
                                    Awaiting Player...
                                </div>
                            ) : (
                                chars.map((item, idx) => {
                                if (item.char === '.') return <span key={idx} className="text-slate-300 mx-1">.</span>;
                                
                                let colorClass = "text-slate-800";
                                let bgClass = "";
                                let label = null;

                                // Only show colors if visualization is active
                                if (showVisualization) {
                                    if (item.isTarget) {
                                    colorClass = "text-blue-600 font-bold";
                                    bgClass = "bg-blue-100 ring-2 ring-blue-200";
                                    label = "Target";
                                    } else if (item.isDecider) {
                                    colorClass = "text-red-500 font-bold";
                                    bgClass = "bg-red-50 ring-1 ring-red-200 dashed-ring";
                                    label = "Decider";
                                    } else if (targetIdx !== -1 && idx > targetIdx) {
                                    colorClass = "text-slate-300"; // Ghost digits
                                    }
                                }

                                return (
                                    <div key={idx} className="flex flex-col items-center relative group">
                                        {label && (
                                        <span className={`absolute -top-6 text-[10px] font-sans font-bold uppercase tracking-wider px-2 py-0.5 rounded-full whitespace-nowrap animate-in fade-in zoom-in duration-300 ${
                                            item.isTarget ? 'bg-blue-600 text-white' : 'bg-red-500 text-white'
                                        }`}>
                                            {label}
                                        </span>
                                        )}
                                        <span className={`w-12 h-16 md:w-16 md:h-20 flex items-center justify-center rounded-lg transition-all duration-500 ${colorClass} ${bgClass}`}>
                                        {item.char}
                                        </span>
                                    </div>
                                );
                                })
                            )}
                        </div>

                        <div className="mt-8 flex items-center justify-center gap-4 text-lg min-h-[50px]">
                            <div className="flex items-center gap-2 transition-all duration-500">
                            {quizStep === 'playing' || !quizMode ? (
                                <>
                                    <span className="text-slate-500">Result:</span>
                                    {showVisualization ? (
                                        <span className={`font-bold text-2xl px-4 py-2 rounded-lg transition-all duration-500 animate-in fade-in zoom-in ${
                                        animate ? 'scale-110 bg-green-100 text-green-700' : 'bg-slate-100 text-slate-900'
                                        }`}>
                                        {results.roundedStr}
                                        </span>
                                    ) : (
                                        <span className="font-bold text-2xl px-4 py-2 rounded-lg bg-slate-100 text-slate-400">
                                        ?
                                        </span>
                                    )}
                                </>
                            ) : null}
                            </div>
                        </div>
                        </Card>

                        {/* Number Line Visual */}
                        <Card className="p-8 overflow-visible relative">
                        <div className="absolute top-4 left-4 text-xs font-bold text-slate-400 uppercase tracking-wider">
                            Number Line
                        </div>
                        
                        {!showVisualization && (
                            <div className="absolute inset-0 bg-white/60 backdrop-blur-sm z-20 flex items-center justify-center">
                                <span className="bg-white border border-slate-200 shadow-sm px-4 py-2 rounded-full text-slate-500 text-sm font-medium">
                                    {quizStep === 'setup' ? 'Enter name to start' : 'Submit answer to reveal'}
                                </span>
                            </div>
                        )}

                        <div className="mt-8 relative h-32 select-none">
                            {/* Main Line */}
                            <div className="absolute top-1/2 left-0 w-full h-1 bg-slate-200 rounded-full"></div>

                            {/* Left Tick (Floor) */}
                            <div className="absolute top-1/2 left-[10%] -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-2">
                            <div className="w-0.5 h-6 bg-slate-300"></div>
                            <span className="text-sm font-medium text-slate-500">{results.lower}</span>
                            </div>

                            {/* Right Tick (Ceiling) */}
                            <div className="absolute top-1/2 left-[90%] -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-2">
                            <div className="w-0.5 h-6 bg-slate-300"></div>
                            <span className="text-sm font-medium text-slate-500">{results.upper}</span>
                            </div>

                            {/* Middle Tick */}
                            <div className="absolute top-1/2 left-[50%] -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-2 opacity-50">
                            <div className="w-px h-4 bg-slate-300"></div>
                            <span className="text-xs text-slate-400">{(results.lower + results.upper) / 2}</span>
                            </div>

                            {/* The Value Marker */}
                            <div 
                            className="absolute top-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center transition-all duration-1000 ease-out z-10"
                            style={{ 
                                left: `${
                                    10 + ((number - results.lower) / (results.upper - results.lower)) * 80
                                }%`
                            }}
                            >
                                <div className="bg-blue-600 text-white font-bold text-xs px-2 py-1 rounded mb-2 shadow-lg whitespace-nowrap">
                                    {number}
                                </div>
                                <div className="w-4 h-4 bg-blue-600 rounded-full border-4 border-white shadow-sm"></div>
                            </div>

                            {/* The Arrow Animation */}
                            <div 
                            className={`absolute top-1/2 -translate-y-1/2 h-1 bg-blue-400/30 transition-all duration-700 ease-out`}
                            style={{
                                left: shouldRoundUp ? '50%' : '10%',
                                width: '40%',
                                opacity: showVisualization ? 0.5 : 0 // Hide arrow if not submitted
                            }}
                            >
                                <div className={`absolute top-1/2 -translate-y-1/2 ${shouldRoundUp ? 'right-0' : 'left-0'}`}>
                                    {shouldRoundUp ? <ChevronRight className="text-blue-400" /> : <ChevronRight className="text-blue-400 rotate-180" />}
                                </div>
                            </div>
                        </div>

                        <div className="mt-4 text-center min-h-[24px]">
                            {showVisualization && (
                                <p className="text-slate-600 animate-in fade-in duration-500">
                                {number} is closer to <strong className="text-slate-900">{shouldRoundUp ? results.upper : results.lower}</strong>
                                </p>
                            )}
                        </div>
                        </Card>

                        {/* Explanation Step */}
                        {showVisualization && (
                        <div className="bg-white border-l-4 border-blue-500 p-4 rounded-r-lg shadow-sm animate-in fade-in slide-in-from-top-4 duration-500">
                            <h4 className="font-bold text-slate-800 mb-2">Analysis:</h4>
                            <ul className="space-y-2 text-sm text-slate-600">
                                <li className="flex items-start gap-2">
                                    <span className="bg-blue-100 text-blue-700 rounded-full w-5 h-5 flex items-center justify-center text-xs mt-0.5">1</span>
                                    <span>
                                        Identifying target digit: The precision requires us to look at the 
                                        <strong className="text-blue-700 mx-1">
                                            {chars[targetIdx]?.char || 'virtual 0'}
                                        </strong> 
                                        at the target position.
                                    </span>
                                </li>
                                <li className="flex items-start gap-2">
                                    <span className="bg-red-100 text-red-700 rounded-full w-5 h-5 flex items-center justify-center text-xs mt-0.5">2</span>
                                    <span>
                                        Checking decider digit: The next digit is 
                                        <strong className="text-red-600 mx-1">{deciderDigit}</strong>.
                                    </span>
                                </li>
                                <li className="flex items-start gap-2">
                                    <span className="bg-green-100 text-green-700 rounded-full w-5 h-5 flex items-center justify-center text-xs mt-0.5">3</span>
                                    <span>
                                        Decision: Since <strong className="mx-1">{deciderDigit}</strong> is 
                                        <strong className={`mx-1 ${shouldRoundUp ? 'text-green-600' : 'text-amber-600'}`}>
                                            {shouldRoundUp ? ' 5' : '< 5'}
                                        </strong>, 
                                        we round {shouldRoundUp ? 'UP (add 1 to target)' : 'DOWN (keep target as is)'}.
                                    </span>
                                </li>
                            </ul>
                        </div>
                        )}
                        
                        {quizMode && !showVisualization && quizStep === 'playing' && (
                            <div className="bg-slate-100 border border-slate-200 border-dashed p-8 rounded-lg text-center text-slate-400">
                                Submit your answer to see the full step-by-step analysis.
                            </div>
                        )}

                    </div>
                    </div>
                </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
